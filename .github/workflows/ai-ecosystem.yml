name: AI CI/CD

env:
  REGISTRY: "registry.digitalocean.com/hakeyn-registry"
  IMAGE_NAME: "sense-ai-image"
  CONTAINER_NAME: "sense_ai"

on:
  push:
    branches: [ main, dev ]
    paths:
      - 'src/**'
      - 'Dockerfile'
      - 'docker-compose.yml'
      - '.github/workflows/ai-ecosystem.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'Dockerfile'
      - 'docker-compose.yml'
      - '.github/workflows/ai-ecosystem.yml'

jobs:
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      run: |
        docker build -t sense-ai:latest -f Dockerfile .

  build_and_push:
    name: Build and Push to Digital Ocean
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install doctl
      uses: digitalocean/action-doctl@v2
      with:
        token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

    - name: Log in to DigitalOcean Container Registry
      run: doctl registry login --expiry-seconds 600

    - name: Build and push container image
      run: |
        SHORT_SHA=$(echo ${{ github.sha }} | head -c7)
        docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$SHORT_SHA -f Dockerfile .
        docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$SHORT_SHA ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$SHORT_SHA
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

  deploy:
    name: Deploy to Digital Ocean Droplet
    runs-on: ubuntu-latest
    needs: build_and_push

    steps:
    - name: Deploy via SSH
      uses: appleboy/ssh-action@v0.1.3
      env:
        GITHUB_SHA: ${{ github.sha }}
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        envs: IMAGE_NAME,REGISTRY,CONTAINER_NAME,GITHUB_SHA
        script: |
          docker login -u ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }} -p ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }} $REGISTRY
          
          docker stop $CONTAINER_NAME || true
          
          docker rm $CONTAINER_NAME || true
          
          docker pull $REGISTRY/$IMAGE_NAME:${GITHUB_SHA:0:7}
          
          docker run -d \
            --restart unless-stopped \
            -p 7070:7070 \
            -v /home/${{ secrets.USERNAME }}/src:/api/src \
            --name $CONTAINER_NAME \
            $REGISTRY/$IMAGE_NAME:${GITHUB_SHA:0:7}
